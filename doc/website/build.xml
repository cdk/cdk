<project name="CDK Website Build File" default="website" basedir=".">

  <property name="build.dir" value="target"/>
  <property name="source.dir" value="source"/>
  
  <property name="docbook-xsl" value="docbook-xsl-1.65.1" />
  <property name="website-docbook-xsl" value="website-2.5.0"/>
  
  <property name="javancsslib" value="javancss28.49"/>
  <property name="javancsslib.dir" value="${javancsslib}"/>

  <target id="layout" name="layout" depends="includes">
    <xslt in="${source.dir}/layout.xml" out="${source.dir}/autolayout.xml" 
          style="${website-docbook-xsl}/xsl/autolayout.xsl"/>
  </target>

  <target name="website-from-autolayout" depends="layout">
    <!-- does should work, but it doesn't -->
    <xslt in="${source.dir}/autolayout.xml" destdir="${build.dir}/" style="${website-docbook-xsl}/xsl/tabular.xsl"/>
  </target>

  <target id="clean" name="clean">
    <delete file="javancss-tmp.xml"/>
    <delete file="keyword.index.xml"/>
    <delete file="classes.mod"/>
    <delete file="${source.dir}/javancss-data.xml"/>
    <delete file="${source.dir}/javadoc-data.xml"/>
    <delete file="${source.dir}/autolayout.xml"/>
    <delete>
      <fileset dir="${source.dir}" includes="*dicts.dbx"/>
      <fileset dir="${source.dir}" includes="*atomtypes.dbx"/>
    </delete>
    <delete>
      <fileset dir="${build.dir}/" includes="*.html"/>
    </delete>
    <delete dir="${docbook-xsl}"/>
    <delete dir="${website-docbook-xsl}"/>
    <delete dir="${javancsslib.dir}"/>
  </target>
  
  <target name="info" id="info" depends="check.includes"/>

  <target name="check.includes" id="check.includes">
    <uptodate property="javancss.uptodate"
      targetfile="${source.dir}/javancss-data.xml">
      <srcfiles dir="../.." includes="CHANGELOG"/>
    </uptodate>
    <echo message="Java source stats uptodate: ${javancss.uptodate}"/>
    <uptodate property="keywordindex.uptodate"
      targetfile="../javadoc/keyword.index.xml">
      <srcfiles dir="../.." includes="CHANGELOG"/>
    </uptodate>
    <echo message="Keyword index uptodate: ${keywordindex.uptodate}"/>
    <uptodate property="depends.uptodate"
      targetfile="../javadoc/depends.xml">
      <srcfiles dir="../.." includes="CHANGELOG"/>
    </uptodate>
    <echo message="Dependency Overview uptodate: ${depends.uptodate}"/>
    <uptodate property="refs.uptodate"
      targetfile="../refs/cheminf.dbx">
      <srcfiles dir="../refs" includes="cheminf.btx"/>
    </uptodate>
    <echo message="Bibliography index uptodate: ${refs.uptodate}"/>
    <uptodate property="classesmod.uptodate"
      targetfile="../javadoc/classes.mod">
      <srcfiles dir="../javadoc" includes="classes.mod"/>
    </uptodate>
    <echo message="Classes module uptodate: ${classesmod.uptodate}"/>
    <uptodate property="dicts.uptodate"
      targetfile="${source.dir}/cdkdict.dbx">
      <srcfiles dir="../../src/org/openscience/cdk/dict/data" includes="cdk.xml"/>
    </uptodate>
    <echo message="Dictionaries in Docbook uptodate: ${dicts.uptodate}"/>
    <uptodate property="atlists.uptodate"
      targetfile="${source.dir}/mol2_atomtypes.dbx">
      <srcfiles dir="../../src/org/openscience/cdk/config/data" includes="mol2_atomtypes.xml"/>
    </uptodate>
    <echo message="Atom Type Lists in Docbook uptodate: ${atlists.uptodate}"/>
  </target>

  <target name="includes" id="includes" 
      depends="check.buildsystem, check.includes,
               javancss, keyword.index, bibliography, dicts, atlists, 
               classes.mod, depends"/>

  <target name="setup.javancss" id="setup.javancss">
    <uptodate property="javancsslib.uptodate"
              targetfile="${javancsslib.dir}"
              srcfile="${javancsslib}.zip" />
  </target>

  <target name="setup.buildsystem" id="setup.buildsystem" depends="setup.javancss">
    <uptodate property="website-docbook-xsl.uptodate"
	      targetfile="${website-docbook-xsl}"
	      srcfile="${website-docbook-xsl}.tar.gz" />
    <uptodate property="docbook-xsl.uptodate"
	      targetfile="${docbook-xsl}"
	      srcfile="${docbook-xsl}.tar.gz" />
  </target>

  <target name="check.buildsystem" id="check.buildsystem" 
      depends="check.docbook, check.docbook-xsl, check.javancss"/>
  
  <target name="check.docbook" depends="setup.buildsystem" unless="docbook-xsl.uptodate" >
    <delete dir="${docbook-xsl}" />
    <mkdir dir="${docbook-xsl}" />
    <untar src="${docbook-xsl}.tar.gz" dest="."
	   compression="gzip" />
  </target>
  
  <target name="check.docbook-xsl" depends="setup.buildsystem" unless="website-docbook-xsl.uptodate" >
    <mkdir dir="${website-docbook-xsl}" />
    <untar src="${website-docbook-xsl}.tar.gz" dest="." compression="gzip" />
    <echo message="Making ${website-docbook-xsl}/xsl/autolayout.xsl internet independent..."/>
    <replace file="${website-docbook-xsl}/xsl/autolayout.xsl">
      <replacetoken><![CDATA[            doctype-system="http://docbook.sourceforge.net/release/website/2.4.1/schema/dtd/autolayout.dtd"]]></replacetoken>
      <replacevalue><![CDATA[            doctype-system="../website-2.5.0/schema/dtd/autolayout.dtd"]]></replacevalue>
    </replace>
    <echo message="Making ${website-docbook-xsl}/xsl/website-common.xsl internet independent..."/>
    <replace file="${website-docbook-xsl}/xsl/website-common.xsl">
      <replacetoken><![CDATA[<xsl:import href="http://docbook.sourceforge.net/release/xsl/current/html/docbook.xsl"/>]]></replacetoken>
      <replacevalue><![CDATA[<xsl:import href="../../docbook-xsl-1.65.1/html/docbook.xsl"/>]]></replacevalue>
    </replace>
  </target>

  <target name="check.javancss" depends="setup.javancss" unless="javancss.uptodate" >
    <mkdir dir="${javancsslib.dir}" />
    <unzip src="${javancsslib}.zip" dest="." />
  </target>

  <target id="website" name="website" depends="layout">
    <xslt basedir="${source.dir}" destdir="${build.dir}" extension=".html"
      includes="*.xml" excludes="build.xml, *layout.xml, java*-data.xml, javancss-tmp.xml, keyword.index.xml"
      style="website.cdk.xsl"/>
  </target>

  <target name="javancss" depends="check.javancss" unless="javancss.uptodate">
    <java classname="javancss.Main" fork="yes"
      output="javancss-tmp.xml">
      <arg value="-all"/>
      <arg value="-xml"/>
      <arg value="-recursive"/>
      <arg value="../../src"/>
      <classpath>
        <pathelement location="${javancsslib.dir}/lib/javancss.jar"/>
        <pathelement location="${javancsslib.dir}/lib/ccl.jar"/>
        <pathelement location="${javancsslib.dir}/lib/jhbasic.jar"/>
      </classpath>
    </java>
    <xslt in="javancss-tmp.xml" out="${source.dir}/javancss-data.xml" style="${source.dir}/xsl/javancss2docbook.xsl"/>
    <xslt in="javancss-tmp.xml" out="${source.dir}/javadoc-data.xml"  style="${source.dir}/xsl/javancss2docbook-javadoc.xsl"/>
  </target>
  
  <target name="dicts" unless="dicts.uptodate">
    <xslt in="../../src/org/openscience/cdk/dict/data/cdk.xml"      out="${source.dir}/cdkdict.dbx" style="${source.dir}/xsl/cmldict2docbook.xsl"/>
    <xslt in="../../src/org/openscience/cdk/dict/data/chemical.xml" out="${source.dir}/chemicaldict.dbx" style="${source.dir}/xsl/cmldict2docbook.xsl"/>
  </target>
  
  <target name="atlists" unless="atlists.uptodate">
    <xslt in="../../src/org/openscience/cdk/config/data/hybridization_atomtypes.xml" out="${source.dir}/hybridization_atomtypes.dbx" style="${source.dir}/xsl/atomtypelist2docbook.xsl"/>
    <xslt in="../../src/org/openscience/cdk/config/data/mol2_atomtypes.xml"          out="${source.dir}/mol2_atomtypes.dbx"          style="${source.dir}/xsl/atomtypelist2docbook.xsl"/>
    <xslt in="../../src/org/openscience/cdk/config/data/pdb_atomtypes.xml"           out="${source.dir}/pdb_atomtypes.dbx"           style="${source.dir}/xsl/atomtypelist2docbook.xsl"/>
    <xslt in="../../src/org/openscience/cdk/config/data/valency_atomtypes.xml"       out="${source.dir}/valency_atomtypes.dbx"       style="${source.dir}/xsl/atomtypelist2docbook.xsl"/>
    <xslt in="../../src/org/openscience/cdk/config/data/structgen_atomtypes.xml"     out="${source.dir}/structgen_atomtypes.dbx"     style="${source.dir}/xsl/atomtypelist2docbook.xsl"/>
  </target>
  
  <target id="keyword.index" name="keyword.index" unless="keywordindex.uptodate">
    <ant dir="../javadoc/" antfile="build.xml" target="keyword.index"/>
    <copy file="keyword.index.xml" tofile="../javadoc/keyword.index.xml"/>
  </target>

  <target id="classes.mod" name="classes.mod" unless="classesmod.uptodate">
    <ant dir="../javadoc/" antfile="build.xml" target="classes.mod"/>
    <copy file="classes.mod" tofile="../javadoc/classes.mod"/>
  </target>
  
  <target id="depends" name="depends" unless="depends.uptodate">
    <ant dir="../javadoc/" antfile="build.xml" target="dependencies"/>
    <move file="builddepends.xml" tofile="../javadoc/builddepends.xml"/>
    <move file="depends.xml" tofile="../javadoc/depends.xml"/>
  </target>

  <target id="bibliography" name="bibliography" unless="refs.uptodate">
    <ant dir="../refs/" antfile="build.xml" target="convertToDocBook" />
  </target>

</project>
